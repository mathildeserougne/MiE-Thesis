#### ESTIMATING THE VULNERABILITY OF INDIAN TRADE ###

# Based on the EU communication, we have a list of HS codes for the vulnerable products.
# We use those HS codes to filter in an adequate way the BACI dataset.

# PACKAGES
install.packages(c("dplyr","readr","stringr","ggplot2"))
# Libraries
library(dplyr)
library(readr)
library(stringr)
library(ggplot2)

#### DATA WORK

# COMBINING 2013-2023
# file paths
file_paths <- paste0("~/work/BACI_Y", 2013:2023, ".csv")
# reading the files, adding each time a column for the corresponding year
baci_combined <- bind_rows(lapply(file_paths, function(file) {
  read_csv(file) %>%
    mutate(year = as.integer(str_replace(file, ".*Y(\\d{4}).*", "\\1"))) # year derived from the name of the csv
}))

# Country codes
country_codes <- read_csv("~/work/country_codes_V202501.csv")

# Renaming the columns
baci_combined <- baci_combined %>%
  rename(
    exporter = i,
    importer = j,
    product  = k,
    value    = v,
    quantity = q
  )

head(baci_combined)

# Merging baci with the country_codes to get country names for exporter and importer
baci_combined <- baci_combined %>%
  left_join(country_codes, by = c("exporter" = "country_code")) %>%
  rename(exporter_name = country_name) %>%
  left_join(country_codes, by = c("importer" = "country_code")) %>%
  rename(importer_name = country_name)


## INDIAN POV
# To get a lighter file, we build an "Indian POV" dataset

# Indian country code = 699 (see country_codes notice of the set)
baci_indian_pov <- baci_combined %>%
  filter(exporter == 699)  

head(baci_indian_pov)

# Saving the file
write_csv(baci_indian_pov, "baci_indian_pov.csv")



# Upload data in the environment in case your R session crashed out of nowhere
baci_indian_pov <- read.csv("~/work/baci_indian_pov.csv")


################################################################################
## VULNERABILITY ISSUE: TARGETED SECTORS #######################################


# HS codes communicated by the EU commission
hs_prefixes <- c("25", "76", "31", "28", "29")


## MEASURING THE WEIGHT OF EXPOSED PRODUCTS ####################################

## First version, without controls on the destination of the exports

# Filtering the data to keep products with code starting with the mentioned prefix
baci_indian_exposed <- baci_indian_pov %>%
  filter(str_detect(as.character(product), paste(paste0("^", hs_prefixes), collapse = "|")))

# Compute total value of exports for exposed products, each year
total_value_exposed_by_year <- baci_indian_exposed %>%
  group_by(year) %>%
  summarise(total_exposed_value = sum(value, na.rm = TRUE))

# Total amount of Indian exports, each year
total_value_india_by_year <- baci_indian_pov %>%
  group_by(year) %>%
  summarise(total_value = sum(value, na.rm = TRUE))

# Relative weight of exposed products, each year
relative_weight_by_year <- inner_join(total_value_exposed_by_year, total_value_india_by_year, by = "year") %>%
  mutate(relative_weight = total_exposed_value / total_value)


# Print result
print(relative_weight_by_year)

# Plot this evolution
ggplot(relative_weight_by_year, aes(x = year, y = relative_weight)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Évolution du poids des produits exposés dans les exportations de l'Inde",
       x = "Année",
       y = "Poids relatif") +
  theme_minimal()



## Second version: restricted to the EU

# List of EU countries
eu_members <- c(
  276, 40, 56, 100, 196, 191, 208, 724, 233, 246,
  251, 300, 348, 372, 380, 428, 440, 442, 470, 528,
  616, 620, 203, 642, 703, 705, 752
)

# Filter data to get only exports towards the EU
baci_indian_pov_eurozone <- baci_indian_pov %>%
  filter(importer %in% eu_members)

# Filter products with HS prefix 
baci_indian_exposed_eurozone <- baci_indian_pov_eurozone %>%
  filter(str_detect(as.character(product), paste(paste0("^", hs_prefixes), collapse = "|")))

# Total value of expors for exposed products, each year
total_value_exposed_by_year <- baci_indian_exposed_eurozone %>%
  group_by(year) %>%
  summarise(total_exposed_value = sum(value, na.rm = TRUE))

# All Indian exports to the EU, each year
total_value_india_by_year <- baci_indian_pov_eurozone %>%
  group_by(year) %>%
  summarise(total_value = sum(value, na.rm = TRUE))

# Relative importance of exposed products, each year
relative_weight_by_year <- inner_join(total_value_exposed_by_year, total_value_india_by_year, by = "year") %>%
  mutate(relative_weight = total_exposed_value / total_value)

# Print
print(relative_weight_by_year)

# Plot evolution
ggplot(relative_weight_by_year, aes(x = year, y = relative_weight)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Relative weight of exposed products in Indian exports to the EU",
       x = "Year",
       y = "Relative weight") +
  theme_minimal()





